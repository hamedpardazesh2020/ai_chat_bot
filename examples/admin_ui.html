<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>پنل مدیریت Rate Limit</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/vazir-font@30.1.0/dist/font-face.css"
    />
    <style>
      :root {
        color-scheme: light;
        --bg: linear-gradient(135deg, #f4f7ff 0%, #dbeafe 35%, #fef9c3 100%);
        --surface: rgba(255, 255, 255, 0.92);
        --surface-strong: #ffffff;
        --surface-subtle: rgba(15, 23, 42, 0.05);
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --accent: #f97316;
        --text: #1f2933;
        --muted: #475569;
        --border: rgba(148, 163, 184, 0.45);
        font-size: 16px;
        font-family: "Vazir", "Vazirmatn", "IRANSans", "Segoe UI", sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2.5rem 1.5rem;
        color: var(--text);
      }

      .panel {
        width: min(1080px, 100%);
        background: var(--surface);
        border-radius: 28px;
        backdrop-filter: blur(18px);
        padding: 2.75rem 3rem;
        box-shadow: 0 28px 60px rgba(15, 23, 42, 0.12);
        border: 1px solid var(--border);
      }

      h1 {
        margin: 0 0 0.75rem;
        font-size: 2.35rem;
        letter-spacing: -0.4px;
        color: var(--primary-dark);
      }

      p.description {
        margin: 0 0 2.3rem;
        color: var(--muted);
        line-height: 1.9;
        font-size: 1.05rem;
      }

      .grid {
        display: grid;
        gap: 1.75rem;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .grid.grid--compact {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.25rem;
      }

      .card {
        background: var(--surface-strong);
        border-radius: 20px;
        padding: 1.9rem;
        border: 1px solid rgba(148, 163, 184, 0.25);
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.1);
      }

      .card h2 {
        margin-top: 0;
        font-size: 1.45rem;
        color: var(--primary);
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text);
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 0.85rem 1rem;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: #f8fbff;
        color: var(--text);
        font-size: 1rem;
        font-family: inherit;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      textarea {
        resize: vertical;
        min-height: 140px;
        line-height: 1.6;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        background: #ffffff;
      }

      button {
        padding: 0.85rem 1.8rem;
        border-radius: 14px;
        border: none;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;
        font-family: inherit;
      }

      button.primary {
        background: linear-gradient(135deg, var(--primary), #3b82f6);
        color: #ffffff;
      }

      button.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(37, 99, 235, 0.28);
      }

      button.secondary {
        background: rgba(37, 99, 235, 0.12);
        color: var(--primary-dark);
        border: 1px solid rgba(37, 99, 235, 0.2);
      }

      button.secondary:hover {
        background: rgba(37, 99, 235, 0.18);
      }

      button.ghost {
        background: rgba(15, 23, 42, 0.04);
        color: var(--primary-dark);
        border: 1px solid transparent;
        padding-inline: 1rem;
        min-width: 100px;
      }

      button.ghost:hover {
        background: rgba(37, 99, 235, 0.1);
      }

      button.full-width {
        width: 100%;
        justify-content: center;
      }

      button:focus-visible {
        outline: 3px solid rgba(37, 99, 235, 0.35);
        outline-offset: 2px;
      }

      .inline-form {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: flex-end;
      }

      .inline-form > div {
        flex: 1 1 220px;
      }

      .stack-form {
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
      }

      .toolbar {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: flex-end;
        margin-bottom: 1rem;
      }

      .toolbar-input {
        flex: 1 1 220px;
      }

      .toolbar-buttons {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .input-with-button {
        display: flex;
        gap: 0.6rem;
        align-items: stretch;
      }

      .input-with-button input {
        flex: 1;
      }

      .status {
        margin-top: 1rem;
        font-size: 0.95rem;
        line-height: 1.6;
        color: var(--muted);
      }

      .status.error {
        color: #dc2626;
      }

      .meta {
        margin: 0.75rem 0 0;
        color: var(--muted);
        font-size: 0.95rem;
      }

      .hint {
        margin-top: 0.5rem;
        color: rgba(15, 23, 42, 0.6);
        font-size: 0.9rem;
        line-height: 1.6;
      }

      .runtime-output {
        margin-top: 1rem;
        background: #f1f5f9;
        border-radius: 14px;
        padding: 1rem;
        direction: ltr;
        text-align: left;
        overflow-x: auto;
        white-space: pre-wrap;
        max-height: 260px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        color: #0f172a;
        font-family: "SFMono-Regular", "Consolas", "Courier New", monospace;
        font-size: 0.92rem;
      }

      ul#bypass-list {
        list-style: none;
        margin: 1.25rem 0 0;
        padding: 0;
        display: grid;
        gap: 0.75rem;
      }

      ul#bypass-list li {
        background: #f8fbff;
        border-radius: 14px;
        padding: 0.95rem 1.15rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.05rem;
        border: 1px solid rgba(148, 163, 184, 0.25);
        gap: 1rem;
      }

      ul#bypass-list li span {
        flex: 1;
        word-break: break-word;
      }

      ul#bypass-list li button {
        padding: 0.55rem 1.2rem;
        font-size: 0.9rem;
        border-radius: 10px;
        background: rgba(239, 68, 68, 0.12);
        color: #b91c1c;
        border: 1px solid rgba(239, 68, 68, 0.2);
      }

      ul#bypass-list li button:hover {
        background: rgba(239, 68, 68, 0.18);
      }

      .tips {
        margin: 0.75rem 0 0;
        padding-inline-start: 1.2rem;
        color: var(--muted);
        line-height: 1.7;
      }

      .tips li {
        margin-bottom: 0.35rem;
      }

      footer {
        margin-top: 2.5rem;
        text-align: center;
        color: rgba(15, 23, 42, 0.55);
        font-size: 0.88rem;
      }

      @media (max-width: 900px) {
        .panel {
          padding: 2rem 1.5rem;
        }
      }

      @media (max-width: 600px) {
        body {
          padding: 1.5rem 1rem;
        }

        .toolbar-buttons {
          width: 100%;
          justify-content: stretch;
        }

        .toolbar-buttons button {
          flex: 1 1 auto;
        }
      }
    </style>
  </head>
  <body>
    <main class="panel">
      <h1>پنل مدیریت ریت لیمیت</h1>
      <p class="description">
        در این رابط کاربری می‌توانید آی‌پی‌های مجاز و وضعیت سرویس را بدون نیاز به
        ابزارهای خط فرمان مدیریت کنید. رابط برای کاربری روزمره در فضای روشن بهینه
        شده و تایپوگرافی آن بر پایه فونت «وزیر» است.
      </p>

      <section class="grid">
        <div class="card">
          <h2>پیکربندی اتصال</h2>
          <div class="grid grid--compact">
            <div>
              <label for="baseUrl">آدرس سرویس (Base URL)</label>
              <input id="baseUrl" type="url" placeholder="https://example.com" />
            </div>
            <div>
              <label for="token">توکن ادمین (X-Admin-Token)</label>
              <div class="input-with-button">
                <input
                  id="token"
                  type="password"
                  placeholder="توکن را وارد کنید"
                  autocomplete="off"
                />
                <button type="button" id="toggleToken" class="ghost">نمایش</button>
              </div>
            </div>
          </div>
          <p class="status" id="connectionStatus"></p>
          <p class="hint">اطلاعات اتصال در مرورگر شما ذخیره می‌شود و هر زمان قابل تغییر است.</p>
        </div>

        <div class="card">
          <h2>دریافت و مدیریت آی‌پی‌ها</h2>
          <div class="toolbar">
            <div class="toolbar-input">
              <label for="searchInput">جستجوی سریع</label>
              <input
                id="searchInput"
                type="search"
                placeholder="عبارت یا آی‌پی را وارد کنید"
                autocomplete="off"
              />
            </div>
            <div class="toolbar-buttons">
              <button id="copyBtn" type="button" class="secondary">کپی لیست</button>
              <button id="exportBtn" type="button" class="secondary">دانلود JSON</button>
            </div>
          </div>
          <button id="fetchBtn" type="button" class="primary full-width">دریافت لیست</button>
          <p class="status" id="fetchStatus"></p>
          <p class="meta" id="countInfo"></p>
          <ul id="bypass-list"></ul>
        </div>

        <div class="card">
          <h2>افزودن آی‌پی جدید</h2>
          <form id="addForm" class="inline-form">
            <div>
              <label for="ipInput">آی‌پی</label>
              <input id="ipInput" type="text" placeholder="مثال: 203.0.113.24" required />
            </div>
            <button type="submit" class="primary">افزودن</button>
          </form>
          <p class="status" id="addStatus"></p>
        </div>

        <div class="card">
          <h2>افزودن گروهی آی‌پی‌ها</h2>
          <form id="bulkForm" class="stack-form">
            <label for="bulkInput">هر آی‌پی را در یک خط وارد کنید</label>
            <textarea
              id="bulkInput"
              placeholder="مثال:
192.0.2.1
198.51.100.25"
            ></textarea>
            <p class="hint">
              ورودی‌های تکراری به صورت خودکار حذف می‌شوند. برای هر آی‌پی درخواست جداگانه ارسال
              خواهد شد.
            </p>
            <button type="submit" class="primary">افزودن آی‌پی‌های انتخابی</button>
          </form>
          <p class="status" id="bulkStatus"></p>
        </div>

        <div class="card">
          <h2>وضعیت اجرای سرویس</h2>
          <p class="hint">
            برای دریافت نمای کلی از وضعیت کنونی سرویس، درخواست Runtime را ارسال کنید.
          </p>
          <button id="runtimeBtn" type="button" class="primary full-width">نمایش وضعیت</button>
          <p class="status" id="runtimeStatus"></p>
          <pre id="runtimeOutput" class="runtime-output"></pre>
        </div>

        <div class="card">
          <h2>راهنمای سریع</h2>
          <ul class="tips">
            <li>قبل از حذف آی‌پی، ابتدا از لیست خروجی JSON تهیه کنید تا نسخه پشتیبان داشته باشید.</li>
            <li>از قابلیت جستجو برای پیدا کردن سریع آی‌پی‌ها در لیست‌های طولانی استفاده کنید.</li>
            <li>برای امنیت بیشتر پس از اتمام کار، دکمه «مخفی کردن» را بزنید تا توکن از دید خارج شود.</li>
            <li>در صورت تغییر آدرس سرویس، تنظیمات ذخیره‌شده را با حذف مقدار فیلد به‌روزرسانی کنید.</li>
          </ul>
        </div>
      </section>

      <footer>
        توسعه یافته برای سرویس FastAPI – تمام درخواست‌ها با هدر ادمین ارسال می‌شوند و با
        رابط روشن و خوانا در اختیار تیم شما قرار می‌گیرند.
      </footer>
    </main>

    <script>
      const baseUrlInput = document.getElementById("baseUrl");
      const tokenInput = document.getElementById("token");
      const toggleTokenBtn = document.getElementById("toggleToken");
      const connectionStatus = document.getElementById("connectionStatus");
      const fetchBtn = document.getElementById("fetchBtn");
      const fetchStatus = document.getElementById("fetchStatus");
      const bypassList = document.getElementById("bypass-list");
      const addForm = document.getElementById("addForm");
      const addStatus = document.getElementById("addStatus");
      const runtimeBtn = document.getElementById("runtimeBtn");
      const runtimeStatus = document.getElementById("runtimeStatus");
      const runtimeOutput = document.getElementById("runtimeOutput");
      const searchInput = document.getElementById("searchInput");
      const copyBtn = document.getElementById("copyBtn");
      const exportBtn = document.getElementById("exportBtn");
      const countInfo = document.getElementById("countInfo");
      const bulkForm = document.getElementById("bulkForm");
      const bulkInput = document.getElementById("bulkInput");
      const bulkStatus = document.getElementById("bulkStatus");

      const STORAGE_KEYS = {
        baseUrl: "admin-ui-base-url",
        token: "admin-ui-token",
      };

      let bypassCache = [];

      function withLocalStorage(callback) {
        try {
          callback();
        } catch (error) {
          console.warn("localStorage is not available:", error);
        }
      }

      function loadSettings() {
        withLocalStorage(() => {
          const savedBaseUrl = localStorage.getItem(STORAGE_KEYS.baseUrl);
          const savedToken = localStorage.getItem(STORAGE_KEYS.token);
          if (savedBaseUrl) {
            baseUrlInput.value = savedBaseUrl;
          }
          if (savedToken) {
            tokenInput.value = savedToken;
          }
        });
      }

      function persistSettings() {
        withLocalStorage(() => {
          const trimmedBaseUrl = baseUrlInput.value.trim();
          const trimmedToken = tokenInput.value.trim();
          if (trimmedBaseUrl) {
            localStorage.setItem(STORAGE_KEYS.baseUrl, trimmedBaseUrl);
          } else {
            localStorage.removeItem(STORAGE_KEYS.baseUrl);
          }
          if (trimmedToken) {
            localStorage.setItem(STORAGE_KEYS.token, trimmedToken);
          } else {
            localStorage.removeItem(STORAGE_KEYS.token);
          }
        });
        connectionStatus.textContent = "تنظیمات ذخیره شد و آماده استفاده است.";
        connectionStatus.classList.remove("error");
      }

      loadSettings();

      function buildHeaders() {
        const token = tokenInput.value.trim();
        return token
          ? {
              "Content-Type": "application/json",
              "X-Admin-Token": token,
            }
          : { "Content-Type": "application/json" };
      }

      function clearStatus() {
        [fetchStatus, addStatus, connectionStatus, runtimeStatus, bulkStatus].forEach(
          (el) => {
            el.textContent = "";
            el.classList.remove("error");
          }
        );
      }

      function showError(element, message) {
        element.textContent = message;
        element.classList.add("error");
      }

      async function request(path, options = {}) {
        const baseUrl = baseUrlInput.value.trim().replace(/\/$/, "");
        if (!baseUrl) {
          throw new Error("لطفاً ابتدا آدرس سرویس را وارد کنید.");
        }
        clearStatus();

        const response = await fetch(`${baseUrl}${path}`, {
          ...options,
          headers: { ...buildHeaders(), ...(options.headers || {}) },
        });

        if (!response.ok) {
          let detail = `${response.status} ${response.statusText}`;
          try {
            const data = await response.json();
            if (data?.message) {
              detail = data.message;
            }
          } catch (_) {
            /* response is not JSON */
          }
          throw new Error(detail);
        }

        if (response.status === 204) {
          return null;
        }

        const text = await response.text();
        return text ? JSON.parse(text) : null;
      }

      function updateCount(visibleCount, filtered) {
        if (!bypassCache.length) {
          countInfo.textContent = "آی‌پی ثبت نشده است.";
          return;
        }
        if (filtered) {
          countInfo.textContent = `نمایش ${visibleCount} از ${bypassCache.length} آی‌پی ثبت‌شده.`;
        } else {
          countInfo.textContent = `تعداد کل آی‌پی‌های ثبت‌شده: ${bypassCache.length}`;
        }
      }

      function renderList(filterText = "") {
        const normalized = filterText.trim().toLowerCase();
        const filtered = normalized
          ? bypassCache.filter((ip) => ip.toLowerCase().includes(normalized))
          : [...bypassCache];

        bypassList.innerHTML = "";

        if (filtered.length === 0) {
          const empty = document.createElement("li");
          empty.textContent = normalized
            ? "آی‌پی مطابق با جستجو یافت نشد."
            : "آی‌پی ثبت نشده است.";
          empty.style.justifyContent = "center";
          empty.style.opacity = "0.7";
          empty.style.fontSize = "1rem";
          bypassList.appendChild(empty);
        } else {
          filtered.forEach((ip) => {
            const li = document.createElement("li");
            li.innerHTML = `<span>${ip}</span>`;
            const btn = document.createElement("button");
            btn.textContent = "حذف";
            btn.addEventListener("click", () => removeIp(ip));
            li.appendChild(btn);
            bypassList.appendChild(li);
          });
        }

        updateCount(filtered.length, Boolean(normalized));
      }

      function getFilteredList() {
        return searchInput.value.trim()
          ? bypassCache.filter((ip) =>
              ip.toLowerCase().includes(searchInput.value.trim().toLowerCase())
            )
          : [...bypassCache];
      }

      async function refreshList() {
        fetchStatus.textContent = "در حال دریافت...";
        fetchStatus.classList.remove("error");
        try {
          const data = await request("/admin/bypass");
          bypassCache = Array.isArray(data) ? data : [];
          renderList(searchInput.value);
          fetchStatus.textContent = "لیست با موفقیت دریافت شد.";
        } catch (error) {
          bypassCache = [];
          renderList(searchInput.value);
          showError(fetchStatus, error.message);
        }
      }

      async function removeIp(ip) {
        addStatus.textContent = "";
        fetchStatus.textContent = `در حال حذف ${ip}...`;
        fetchStatus.classList.remove("error");
        try {
          await request(`/admin/bypass/${encodeURIComponent(ip)}`, {
            method: "DELETE",
          });
          fetchStatus.textContent = "آی‌پی با موفقیت حذف شد.";
          await refreshList();
        } catch (error) {
          showError(fetchStatus, error.message);
        }
      }

      async function fetchRuntime() {
        runtimeStatus.textContent = "در حال دریافت...";
        runtimeStatus.classList.remove("error");
        try {
          const data = await request("/admin/runtime");
          runtimeOutput.textContent = JSON.stringify(data, null, 2);
          runtimeStatus.textContent = "اطلاعات با موفقیت دریافت شد.";
        } catch (error) {
          runtimeOutput.textContent = "";
          showError(runtimeStatus, error.message);
        }
      }

      addForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        addStatus.textContent = "در حال ارسال...";
        addStatus.classList.remove("error");

        const ipValue = document.getElementById("ipInput").value.trim();
        if (!ipValue) {
          showError(addStatus, "لطفاً آی‌پی را وارد کنید.");
          return;
        }

        try {
          await request("/admin/bypass", {
            method: "POST",
            body: JSON.stringify({ ip: ipValue }),
          });
          addStatus.textContent = "آی‌پی با موفقیت افزوده شد.";
          document.getElementById("ipInput").value = "";
          await refreshList();
        } catch (error) {
          showError(addStatus, error.message);
        }
      });

      bulkForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        bulkStatus.textContent = "در حال پردازش...";
        bulkStatus.classList.remove("error");

        const rawValues = bulkInput.value
          .split(/\r?\n/)
          .map((line) => line.trim())
          .filter(Boolean);

        if (!rawValues.length) {
          showError(bulkStatus, "هیچ آی‌پی معتبری وارد نشده است.");
          return;
        }

        const uniqueIps = [...new Set(rawValues)];
        const failed = [];
        let successCount = 0;

        for (const ip of uniqueIps) {
          try {
            await request("/admin/bypass", {
              method: "POST",
              body: JSON.stringify({ ip }),
            });
            successCount += 1;
          } catch (error) {
            failed.push({ ip, message: error.message });
          }
        }

        if (failed.length) {
          const failedIps = failed.map((item) => item.ip).join("، ");
          showError(
            bulkStatus,
            `افزودن ${failed.length} آی‌پی با خطا مواجه شد: ${failedIps}`
          );
        } else {
          bulkStatus.textContent = `${successCount} آی‌پی با موفقیت افزوده شد.`;
          bulkInput.value = "";
        }

        await refreshList();
      });

      fetchBtn.addEventListener("click", refreshList);
      runtimeBtn.addEventListener("click", fetchRuntime);

      [baseUrlInput, tokenInput].forEach((input) => {
        input.addEventListener("input", persistSettings);
      });

      searchInput.addEventListener("input", () => {
        renderList(searchInput.value);
      });

      copyBtn.addEventListener("click", async () => {
        const filtered = getFilteredList();
        if (!filtered.length) {
          showError(fetchStatus, "آی‌پی‌ای برای کپی وجود ندارد.");
          return;
        }
        try {
          await navigator.clipboard.writeText(filtered.join("\n"));
          fetchStatus.textContent = "لیست در کلیپ‌بورد کپی شد.";
          fetchStatus.classList.remove("error");
        } catch (error) {
          showError(fetchStatus, "امکان دسترسی به کلیپ‌بورد وجود ندارد.");
        }
      });

      exportBtn.addEventListener("click", () => {
        const filtered = getFilteredList();
        if (!filtered.length) {
          showError(fetchStatus, "آی‌پی‌ای برای ذخیره وجود ندارد.");
          return;
        }
        const blob = new Blob([JSON.stringify(filtered, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "bypass-list.json";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        fetchStatus.textContent = "فایل JSON با موفقیت آماده شد.";
        fetchStatus.classList.remove("error");
      });

      if (toggleTokenBtn) {
        toggleTokenBtn.addEventListener("click", () => {
          const isHidden = tokenInput.type === "password";
          tokenInput.type = isHidden ? "text" : "password";
          toggleTokenBtn.textContent = isHidden ? "مخفی کردن" : "نمایش";
          toggleTokenBtn.setAttribute("aria-pressed", String(isHidden));
        });
      }

      // مقدار اولیه لیست برای هماهنگی با پیام شمارنده
      renderList("");
    </script>
  </body>
</html>
