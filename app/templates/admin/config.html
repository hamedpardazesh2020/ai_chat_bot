{% extends "admin/base.html" %}

{% block title %}Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª{% endblock %}

{% block content %}
  <section>
    <h1 style="margin-top: 0; color: var(--primary)">Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø±Ù†Ø§Ù…Ù‡</h1>
    <p style="color: var(--muted); line-height: 1.8">
      Ø§Ø² Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø§ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ù…Ø³ØªÙ‚ÛŒÙ… Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯.
      ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± ÙØ§ÛŒÙ„ Ú©Ø§Ù†ÙÛŒÚ¯ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ Ú©Ø§Ù…Ù„ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ø³Ø±ÙˆÛŒØ³ Ø¯Ø§Ø±Ø¯.
    </p>

    <div class="config-info" style="margin: 1.5rem 0; padding: 1rem; background: var(--surface-subtle); border-radius: 12px; border: 1px solid var(--border)">
      <p style="margin: 0; color: var(--muted); font-size: 0.9rem">
        <strong>Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„:</strong> <span id="configFilePath" style="font-family: monospace; color: var(--primary)">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
      </p>
    </div>

    <div style="margin: 1.5rem 0; padding: 1.5rem; background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%); border-radius: 12px; border: 2px solid #f59e0b; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1)">
      <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem">
        <div>
          <h3 style="margin: 0 0 0.5rem 0; color: #92400e; font-size: 1.1rem">Ø±ÛŒØ³ØªØ§Ø±Øª Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†</h3>
          <p style="margin: 0; color: #78350f; font-size: 0.9rem">Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª ØªÙ†Ø¸ÛŒÙ…Ø§ØªØŒ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯.</p>
        </div>
        <button id="restartBtn" class="primary" style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; padding: 0.8rem 1.8rem; font-weight: 600; border: none; box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.3); transition: all 0.3s ease">
          ğŸ”„ Ø±ÛŒØ³ØªØ§Ø±Øª Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†
        </button>
      </div>
    </div>

    <div id="configStatus" class="status-message" style="margin: 1rem 0"></div>

    <div id="configContainer" style="margin-top: 2rem">
      <p style="text-align: center; color: var(--muted)">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª...</p>
    </div>

    <div style="margin-top: 2rem; padding: 1.5rem; background: var(--surface-subtle); border-radius: 12px; border: 1px solid var(--border)">
      <h3 style="margin-top: 0; color: var(--primary)">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§</h3>
      <div style="display: grid; gap: 1rem; font-size: 0.9rem">
        <div>
          <strong>admin_token:</strong> ØªÙˆÚ©Ù† Ø§Ù…Ù†ÛŒØªÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª
        </div>
        <div>
          <strong>default_provider_name:</strong> Ù†Ø§Ù… Ø§Ø±Ø§Ø¦Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ (Ù…Ø«Ù„Ø§Ù‹ mcp-agent ÛŒØ§ openai)
        </div>
        <div>
          <strong>openrouter_key:</strong> Ú©Ù„ÛŒØ¯ API Ø¨Ø±Ø§ÛŒ Ø³Ø±ÙˆÛŒØ³ OpenRouter
        </div>
        <div>
          <strong>initial_system_prompt:</strong> Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ…ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù…Ú©Ø§Ù„Ù…Ù‡
        </div>
        <div>
          <strong>redis_url:</strong> Ø¢Ø¯Ø±Ø³ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Redis
        </div>
        <div>
          <strong>rate_rps:</strong> ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø¬Ø§Ø² Ø¯Ø± Ù‡Ø± Ø«Ø§Ù†ÛŒÙ‡
        </div>
        <div>
          <strong>rate_burst:</strong> Ø­Ø¯Ø§Ú©Ø«Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†
        </div>
        <div>
          <strong>memory_default:</strong> ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡
        </div>
        <div>
          <strong>memory_max:</strong> Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡
        </div>
        <div>
          <strong>history_storage_backend:</strong> Ù†ÙˆØ¹ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø² ØªØ§Ø±ÛŒØ®Ú†Ù‡ (none, mysql, mongodb, redis)
        </div>
        <div>
          <strong>metrics_enabled:</strong> ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ù…ØªØ±ÛŒÚ©â€ŒÙ‡Ø§ (true/false)
        </div>
        <div>
          <strong>log_level:</strong> Ø³Ø·Ø­ Ù„Ø§Ú¯ (DEBUG, INFO, WARNING, ERROR)
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block extra_js %}
  <script>
    (async function () {
      const configContainer = document.getElementById("configContainer");
      const configStatus = document.getElementById("configStatus");
      const configFilePath = document.getElementById("configFilePath");
      const restartBtn = document.getElementById("restartBtn");

      function showStatus(message, isError = false) {
        if (!configStatus) return;
        configStatus.textContent = message;
        configStatus.classList.toggle("error", Boolean(isError));
      }

      // Handle restart button click
      if (restartBtn) {
        restartBtn.addEventListener("click", async () => {
          if (!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø±Ø§ Ø±ÛŒØ³ØªØ§Ø±Øª Ú©Ù†ÛŒØ¯ØŸ\n\nØ§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¨Ù‡ Ù…Ø¯Øª Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯.")) {
            return;
          }

          try {
            restartBtn.disabled = true;
            restartBtn.textContent = "ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø±ÛŒØ³ØªØ§Ø±Øª...";
            restartBtn.style.opacity = "0.7";

            await window.AdminUI.adminFetch("/admin/restart", {
              method: "POST",
            });

            showStatus("Ø±ÛŒØ³ØªØ§Ø±Øª Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¢ØºØ§Ø² Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...");

            // Show countdown and auto-reload
            let countdown = 5;
            const countdownInterval = setInterval(() => {
              countdown--;
              showStatus(`Ø±ÛŒØ³ØªØ§Ø±Øª Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¢ØºØ§Ø² Ø´Ø¯. ØµÙØ­Ù‡ Ø¯Ø± ${countdown} Ø«Ø§Ù†ÛŒÙ‡ Ø¯ÛŒÚ¯Ø± Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯...`);
              if (countdown <= 0) {
                clearInterval(countdownInterval);
                window.location.reload();
              }
            }, 1000);

          } catch (error) {
            showStatus(`Ø®Ø·Ø§ Ø¯Ø± Ø±ÛŒØ³ØªØ§Ø±Øª Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†: ${error.message}`, true);
            restartBtn.textContent = "ğŸ”„ Ø±ÛŒØ³ØªØ§Ø±Øª Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†";
            restartBtn.disabled = false;
            restartBtn.style.opacity = "1";
          }
        });
      }

      function parseValue(valueStr, currentValue) {
        const trimmed = valueStr.trim();

        // Handle null/none values
        if (trimmed === "null" || trimmed === "none" || trimmed === "") {
          return null;
        }

        // Handle boolean values
        if (trimmed.toLowerCase() === "true") return true;
        if (trimmed.toLowerCase() === "false") return false;

        // Handle numbers
        if (!isNaN(trimmed) && trimmed !== "") {
          const num = Number(trimmed);
          return Number.isInteger(num) ? parseInt(trimmed, 10) : parseFloat(trimmed);
        }

        // Handle arrays (JSON format)
        if (trimmed.startsWith("[") && trimmed.endsWith("]")) {
          try {
            return JSON.parse(trimmed);
          } catch (e) {
            return trimmed;
          }
        }

        // Return as string
        return trimmed;
      }

      function createFieldEditor(fieldName, value) {
        const fieldDiv = document.createElement("div");
        fieldDiv.className = "config-field";
        fieldDiv.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: var(--surface-strong); border-radius: 16px; border: 1px solid var(--border)";

        const label = document.createElement("label");
        label.style.cssText = "display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text)";
        label.textContent = fieldName;

        const inputGroup = document.createElement("div");
        inputGroup.style.cssText = "display: flex; gap: 0.75rem; align-items: flex-start";

        let input;
        const valueType = typeof value;

        if (valueType === "boolean") {
          input = document.createElement("select");
          input.style.cssText = "flex: 1; padding: 0.7rem; border-radius: 10px; border: 1px solid var(--border); font-family: inherit; font-size: 0.95rem";
          const trueOpt = document.createElement("option");
          trueOpt.value = "true";
          trueOpt.textContent = "true";
          const falseOpt = document.createElement("option");
          falseOpt.value = "false";
          falseOpt.textContent = "false";
          input.appendChild(trueOpt);
          input.appendChild(falseOpt);
          input.value = value ? "true" : "false";
        } else if (fieldName.includes("prompt") || (typeof value === "string" && value.length > 100)) {
          input = document.createElement("textarea");
          input.rows = 4;
          input.style.cssText = "flex: 1; padding: 0.7rem; border-radius: 10px; border: 1px solid var(--border); font-family: inherit; font-size: 0.95rem; resize: vertical";
          input.value = value === null ? "" : String(value);
        } else if (Array.isArray(value)) {
          input = document.createElement("textarea");
          input.rows = 3;
          input.style.cssText = "flex: 1; padding: 0.7rem; border-radius: 10px; border: 1px solid var(--border); font-family: monospace; font-size: 0.9rem; resize: vertical";
          input.value = JSON.stringify(value, null, 2);
        } else {
          input = document.createElement("input");
          input.type = "text";
          input.style.cssText = "flex: 1; padding: 0.7rem; border-radius: 10px; border: 1px solid var(--border); font-family: inherit; font-size: 0.95rem";
          input.value = value === null ? "" : String(value);
        }

        const saveBtn = document.createElement("button");
        saveBtn.className = "primary";
        saveBtn.textContent = "Ø°Ø®ÛŒØ±Ù‡";
        saveBtn.style.cssText = "padding: 0.7rem 1.5rem; white-space: nowrap";
        saveBtn.onclick = async () => {
          try {
            saveBtn.disabled = true;
            saveBtn.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...";

            const newValue = parseValue(input.value, value);

            await window.AdminUI.adminFetch("/admin/config", {
              method: "PUT",
              body: JSON.stringify({ field: fieldName, value: newValue }),
            });

            showStatus(`ÙÛŒÙ„Ø¯ "${fieldName}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯. Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§ØªØŒ Ø³Ø±ÙˆÛŒØ³ Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯.`);
            saveBtn.textContent = "âœ“ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯";
            setTimeout(() => {
              saveBtn.textContent = "Ø°Ø®ÛŒØ±Ù‡";
              saveBtn.disabled = false;
            }, 2000);
          } catch (error) {
            showStatus(`Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ÙÛŒÙ„Ø¯ "${fieldName}": ${error.message}`, true);
            saveBtn.textContent = "Ø°Ø®ÛŒØ±Ù‡";
            saveBtn.disabled = false;
          }
        };

        inputGroup.appendChild(input);
        inputGroup.appendChild(saveBtn);
        fieldDiv.appendChild(label);
        fieldDiv.appendChild(inputGroup);

        return fieldDiv;
      }

      async function loadConfig() {
        try {
          showStatus("Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª...");
          const data = await window.AdminUI.adminFetch("/admin/config");

          if (configFilePath) {
            configFilePath.textContent = data.file_path;
          }

          configContainer.innerHTML = "";

          // Group fields by category
          const categories = {
            "ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ": ["admin_token", "default_provider_name", "initial_system_prompt", "provider_timeout_seconds"],
            "OpenRouter": ["openrouter_key", "openrouter_base_url", "openrouter_default_model"],
            "OpenAI": ["openai_api_key"],
            "MCP Agent": ["mcp_agent_config", "mcp_agent_servers", "mcp_agent_app_name", "mcp_agent_instruction", "mcp_agent_llm_provider", "mcp_agent_default_model"],
            "Redis Ùˆ Rate Limiting": ["redis_url", "rate_rps", "rate_burst"],
            "Ø­Ø§ÙØ¸Ù‡": ["memory_default", "memory_max"],
            "Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡": ["history_storage_backend", "history_namespace", "history_mysql_host", "history_mysql_port", "history_mysql_user", "history_mysql_password", "history_mysql_database", "history_mysql_session_table", "history_mysql_message_table", "history_mongodb_uri", "history_mongodb_database", "history_mongodb_session_collection", "history_mongodb_message_collection", "history_redis_url"],
            "Ù…ØªØ±ÛŒÚ©â€ŒÙ‡Ø§ Ùˆ Ù„Ø§Ú¯": ["metrics_enabled", "log_level"],
          };

          for (const [categoryName, fields] of Object.entries(categories)) {
            const categorySection = document.createElement("div");
            categorySection.style.cssText = "margin-bottom: 2.5rem";

            const categoryTitle = document.createElement("h2");
            categoryTitle.textContent = categoryName;
            categoryTitle.style.cssText = "color: var(--primary); margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border)";
            categorySection.appendChild(categoryTitle);

            for (const field of fields) {
              if (field in data.config) {
                categorySection.appendChild(createFieldEditor(field, data.config[field]));
              }
            }

            configContainer.appendChild(categorySection);
          }

          showStatus("ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯.");
        } catch (error) {
          showStatus(`Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª: ${error.message}`, true);
          configContainer.innerHTML = `<p style="color: var(--muted); text-align: center">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª. Ù„Ø·ÙØ§Ù‹ ØªÙˆÚ©Ù† Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.</p>`;
        }
      }

      await loadConfig();
    })();
  </script>
{% endblock %}
